---
title: "How to Analyze Probabilistic Monitoring Data (multiple parameters) for Integrated Report Chapter"
author: "Emma Jones"
date: "May 4, 2018"
output: html_document
---

This document walks you through the steps of calculating design weights, running analyses, and writing the Integrated Report chapter for the Probabilistic Monitoring Program due to EPA every two years. This document overviews the 2018 IR ProbMon chapter and the Change Analysis chapter due every ~6 years.

### Data Organization
Starting with an organized 'design status' database that has all Probmon stations (sampled or not) organized with stream order information. This data is important to note all sites that were evaluated and whether or not they should be included in the design weight process. Environmental, chemical, landcover, etc. data is organized in a separate spreadsheet (brought in later) that is joined to the weight category results. 

```{r startup, echo=FALSE, warning=FALSE}
# R version 3.4.4 "Someone to Lean On"
suppressPackageStartupMessages(library(tidyverse))#1.2.1
suppressPackageStartupMessages(library(sf))#0.6-1
suppressPackageStartupMessages(library(spsurvey))#3.3
suppressPackageStartupMessages(library(DT))#0.4
suppressPackageStartupMessages(library(purrr))#0.2.4
```

Bring in appropriate datasets. Always start with VSCI (VSCI/VCPMI) first because this parameter will have the best information on whether or not to include the station for design weight calculations. 
```{r bringInTSData}

#### Read in master field data sampled at all sites
# Select the parameters we want to run
# rename a few parameters to work better in R
surveyData <- readxl::read_excel('originalData/ProbMonWadeable2001-2016.xlsx',sheet='ProbMonData2001-2016_EVJ') %>%
  select(StationID_Trend,Year,DO:MetalCCU,CALCIUM:MERCURY,wshdImpPCT) %>% 
  dplyr::rename(siteID=StationID_Trend,Ortho_P= "Ortho-P",
                X70331VFine=`70331VFine`)

```

And now bring in design status data (for VSCI/VCPMI). It is best to use this as the default design status dataset (and adjust TS to OT if not sampled) because it is the most complete version of the data.
```{r bringInDesignStatusData}
designStatus <- readxl::read_excel('originalData/biology.xlsx',sheet='biology2018') %>%
  mutate(#BioPanel= dplyr::recode(BioPanel,'Phase1'='BioPhase1','Phase2'='BioPhase2',
    #                         'Phase3'='BioPhase3','Phase4'='BioPhase4'),   # recode biophase
    IR2008 = replace(IR2008, IR2008==1, NA),
    IR2010 = replace(IR2010, IR2010==1, NA),
    IR2012 = replace(IR2012, IR2012==1, NA),
    IR2014 = replace(IR2014, IR2014==1, NA),
    IR2016 = replace(IR2016, IR2016==1, NA),
    IR2018 = replace(IR2018, IR2018==1, NA),
    Panel1 = ifelse(Panel == "Phase1", 1, NA),
    Panel2 = ifelse(Panel == "Phase2", 1, NA),
    BioPanel1 = ifelse(BioPanel == "Phase1", 1, NA),
    BioPanel2 = ifelse(BioPanel == "Phase2", 1, NA),
    BioPanel3 = ifelse(BioPanel == "Phase3", 1, NA),
    BioPanel4 = ifelse(BioPanel == "Phase4", 1, NA)) %>% # housekeeping: recode biophase and change 1's to NA's to indicate it wasnt sampled in that window, break up Panel and BioPanel windows to separate columns for weight adjustment purposes
  dplyr::rename(siteID=sampleID ) # start playing nicely with spsurvey)


```

These are the data windows we are looking at for 2018 IR:

* Full sample window (2001-2016)
* 2018 IR (2011-2016)
* 2016 IR (2009-2014)
* 2014 IR (2007-2012)
* 2012 IR (2005-2010)
* 2010 IR (2003-2008)
* 2008 IR (2001-2007)
* Phases (Phase 1= 2001-2008; Phase 2= 2009-2016)
* BioPhases (Phase 1 = 2001-2004; Phase 2 = 2005-2008; Phase 3 = 2009-2012; Phase 4 = 2013-2016;)



#### Functions for Weight Adjustments and run all CDF data by subpopulations

The following functions run the CDF analyses for all parameters chosen from the surveyData dataframe (you can modify the selection to increase/decrease parameters run). The subpopEstimate() function runs each subpopulation and nests inside the listOfResults(), which outputs a list of all subpopulation results. The allCDFresults() adjusts all weights according to sample window and then calls the listOfResults() to run all the CDF, percentile, and population estimates for each subpopulation. See below for how to run each of these functions and how to view outputs.

```{r allFunctions}
## Subpopulation estimates by parameter
subpopEstimate <- function(finalData,parameter, subpopulationCategory, subpopulation, altName, specialWeight){
  # Build in catch in case whole population needed
  if(is.na(subpopulationCategory) & subpopulation == "Virginia"){
    subpopData <- finalData
    sites.ext <- select(subpopData, siteID) %>% mutate(Use = TRUE)
    subpop.ext <- select(subpopData,siteID) %>% mutate(Region = 'Virginia')
  }else{
    subpopData <- finalData[ finalData[[subpopulationCategory]] == subpopulation, ] 
    if(nrow(subpopData) == nrow(finalData)){ # special catch for IR windows not filtering correctly
      subpopData <- finalData[ !is.na(finalData[[subpopulationCategory]] ), ] 
    }}
  
  # If no data in subpopulation, keep moving
  if(nrow(subpopData) !=0){
    sites.ext <- select(subpopData, siteID) %>% mutate(Use = TRUE)
    # Special Cases to match existing terminology for each Subpopulation
    if(is.na(altName)){
      subpop.ext <- select(subpopData,siteID) %>% mutate(Region = subpopulation)
    }else{
      subpop.ext <- select(subpopData,siteID) %>% mutate(Region = altName)
    }
    
   
    
  # Choose correct final weight and filter to stratum = 1
    if(specialWeight==FALSE){
      finalweight <- subpopData$finalweight_all
    }else{
      finalweight <- as.numeric(as.matrix(subpopData[,specialWeight]))
    }

  
  design.ext <- mutate(subpopData,siteID = siteID, stratum = "1", wgt = finalweight, xcoord = xmarinus, ycoord = ymarinus) %>%
    select(siteID, stratum, wgt, xcoord, ycoord)
  
  data.cont.ext <- select(finalData, siteID, parameter)
  
  subpopStatus <- cont.analysis(sites = data.frame(sites.ext), subpop = data.frame(subpop.ext), design = data.frame(design.ext), 
                                data.cont = data.frame(data.cont.ext),
                                pctval=c(1, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 99), 
                                conf=95, vartype="Local")
  return(subpopStatus)}else{return(list())}
}

# Now build it all into a single function that returns a list of lists (one list object per estimate, 
# each estimate is a list of of 4 dataframes where the important ones ($CDF and $Pct) can easily be 
# reached with list calls noted at bottom of page)
listOfResults <- function(popstatus.est, finalData, parameterName){
  list(
    popstatus.est = popstatus.est,
    dataAnalyzed = finalData,
    # All Virginia
    estimateVirginia = subpopEstimate(finalData,parameterName,NA, 'Virginia',NA, specialWeight=FALSE),
    # By Basin
    estimateRoanoke = subpopEstimate(finalData,parameterName, 'Basin', 'Roanoke','Roanoke Basin', specialWeight=FALSE),
    estimateJames = subpopEstimate(finalData,parameterName, 'Basin', 'James','James Basin', specialWeight=FALSE) ,
    estimatePotomacShenandoah = subpopEstimate(finalData,parameterName, 'Basin', 'Potomac-Shenandoah',NA, specialWeight=FALSE) ,
    estimateRappahannockYork = subpopEstimate(finalData,parameterName, 'Basin', 'Rappahannock-York',NA, specialWeight=FALSE),
    estimateNew = subpopEstimate(finalData,parameterName, 'Basin', 'New',NA, specialWeight=FALSE) ,
    estimateChowan = subpopEstimate(finalData,parameterName, 'Basin', 'Chowan',NA, specialWeight=FALSE), 
    estimateTennessee = subpopEstimate(finalData,parameterName, 'Basin', 'Tennessee',NA, specialWeight=FALSE), 
    estimateHolston = subpopEstimate(finalData,parameterName, 'SubBasin', 'Holston',NA, specialWeight=FALSE) ,
    estimateBigSandy = subpopEstimate(finalData,parameterName, 'SubBasin', 'Big Sandy',NA, specialWeight=FALSE) ,
    estimateClinchPowell = subpopEstimate(finalData,parameterName, 'SubBasin', 'Clinch-Powell',NA, specialWeight=FALSE) ,
    estimatePotomac = subpopEstimate(finalData,parameterName, 'SubBasin', 'Potomac',NA, specialWeight=FALSE) ,
    estimateShenandoah = subpopEstimate(finalData,parameterName, 'SubBasin', 'Shenandoah',NA, specialWeight=FALSE) ,
    estimateRappahannock = subpopEstimate(finalData,parameterName, 'SubBasin', 'Rappahannock',NA, specialWeight=FALSE) ,
    estimateYork = subpopEstimate(finalData,parameterName, 'SubBasin', 'York',NA, specialWeight=FALSE) ,
    # By Ecoregion
    estimatePiedmont = subpopEstimate(finalData,parameterName, 'EcoRegion', 'Piedmont',NA, specialWeight=FALSE) ,
    estimateNorthernPiedmont = subpopEstimate(finalData,parameterName, 'EcoRegion', 'Northern Piedmont',NA, specialWeight=FALSE) ,
    estimateCARV = subpopEstimate(finalData,parameterName, 'EcoRegion', 'Central Appalachian Ridges and Valleys',NA, specialWeight=FALSE) ,
    estimateSEplains = subpopEstimate(finalData,parameterName, 'EcoRegion', 'Southeastern Plains',NA, specialWeight=FALSE) ,
    estimateBRM = subpopEstimate(finalData,parameterName, 'EcoRegion', 'Blue Ridge Mountains',NA, specialWeight=FALSE) ,
    estimateMountainBioregion = subpopEstimate(finalData,parameterName, 'BioRegion', 'Mountain','Mountain Bioregion', specialWeight=FALSE),
    estimatePiedmontBioregion = subpopEstimate(finalData,parameterName, 'BioRegion', 'Piedmont','Piedmont Bioregion', specialWeight=FALSE) ,
    estimateCoastBioregion = subpopEstimate(finalData,parameterName, 'BioRegion', 'Coast', 'Coast Bioregion', specialWeight=FALSE),
    # By Order
    estimateFirstOrder = subpopEstimate(finalData,parameterName, 'Order', '1','First Order', specialWeight=FALSE) ,
    estimateSecondOrder = subpopEstimate(finalData,parameterName, 'Order', '2','Second Order', specialWeight=FALSE) ,
    estimateThirdOrder = subpopEstimate(finalData,parameterName, 'Order', '3','Third Order', specialWeight=FALSE) ,
    estimateFourthOrder = subpopEstimate(finalData,parameterName, 'Order', '4','Fourth Order', specialWeight=FALSE) ,
    estimateFifthOrder = subpopEstimate(finalData,parameterName, 'Order', '5','Fifth Order', specialWeight=FALSE) ,
    # By Basin Size
    estimateBasin1 = subpopEstimate(finalData,parameterName, 'BasinSize', '1','<1 square mile', specialWeight=FALSE) ,
    estimateBasin2 = subpopEstimate(finalData,parameterName, 'BasinSize', '2','1 to 10 square mile', specialWeight=FALSE) ,
    estimateBasin3 = subpopEstimate(finalData,parameterName, 'BasinSize', '3','10 to 200 square mile', specialWeight=FALSE) ,
    estimateBasin4 = subpopEstimate(finalData,parameterName, 'BasinSize', '4','>200 square mile', specialWeight=FALSE) ,
    # By Year
    estimate2001 = subpopEstimate(finalData,parameterName, 'Year', '2001','Year 2001', specialWeight='finalweight_Year') ,
    estimate2002 = subpopEstimate(finalData,parameterName, 'Year', '2002','Year 2002', specialWeight='finalweight_Year'), 
    estimate2003 = subpopEstimate(finalData,parameterName, 'Year', '2003','Year 2003', specialWeight='finalweight_Year') ,
    estimate2004 = subpopEstimate(finalData,parameterName, 'Year', '2004','Year 2004', specialWeight='finalweight_Year') ,
    estimate2005 = subpopEstimate(finalData,parameterName, 'Year', '2005','Year 2005', specialWeight='finalweight_Year') ,
    estimate2006 = subpopEstimate(finalData,parameterName, 'Year', '2006','Year 2006', specialWeight='finalweight_Year') ,
    estimate2007 = subpopEstimate(finalData,parameterName, 'Year', '2007','Year 2007', specialWeight='finalweight_Year') ,
    estimate2008 = subpopEstimate(finalData,parameterName, 'Year', '2008','Year 2008', specialWeight='finalweight_Year') ,
    estimate2009 = subpopEstimate(finalData,parameterName, 'Year', '2009','Year 2009', specialWeight='finalweight_Year') ,
    estimate2010 = subpopEstimate(finalData,parameterName, 'Year', '2010','Year 2010', specialWeight='finalweight_Year') ,
    estimate2011 = subpopEstimate(finalData,parameterName, 'Year', '2011','Year 2011', specialWeight='finalweight_Year') ,
    estimate2012 = subpopEstimate(finalData,parameterName, 'Year', '2012','Year 2012', specialWeight='finalweight_Year') ,
    estimate2013 = subpopEstimate(finalData,parameterName, 'Year', '2013','Year 2013', specialWeight='finalweight_Year') ,
    estimate2014 = subpopEstimate(finalData,parameterName, 'Year', '2014','Year 2014', specialWeight='finalweight_Year') ,
    estimate2015 = subpopEstimate(finalData,parameterName, 'Year', '2015','Year 2015', specialWeight='finalweight_Year') ,
    estimate2016 = subpopEstimate(finalData,parameterName, 'Year', '2016','Year 2016', specialWeight='finalweight_Year') ,
    # By Phase
    estimatePhase1 = subpopEstimate(finalData,parameterName, 'Panel', 'Phase1','Phase One 2001-2009', specialWeight='finalweight_Panel1') ,
    estimatePhase2 = subpopEstimate(finalData,parameterName, 'Panel', 'Phase2','Phase Two 2009-2016', specialWeight='finalweight_Panel2') ,
    # Bay/ NonBay
    estimateBay = subpopEstimate(finalData,parameterName, 'BayShed', 'Bay','Bay Watersheds 2001-2016', specialWeight=FALSE),
    estimateNonBay = subpopEstimate(finalData,parameterName, 'BayShed', 'NonBay','Non-Bay Watersheds 2001-2016', specialWeight=FALSE),
    estimateBayPhase1 = subpopEstimate(finalData,parameterName, 'BayPanel', 'BayPhase1','Bay Watersheds 2001-2009', specialWeight='finalweight_Panel1'),
    estimateBayPhase2 = subpopEstimate(finalData,parameterName, 'BayPanel', 'BayPhase2','Bay Watersheds 2009-2016', specialWeight='finalweight_Panel2'),
    estimateNonBayPhase1 = subpopEstimate(finalData,parameterName, 'BayPanel', 'NonBayPhase1','Non-Bay Watersheds 2001-2009', specialWeight='finalweight_Panel1'),
    estimateNonBayPhase2 = subpopEstimate(finalData,parameterName, 'BayPanel', 'NonBayPhase2','Non-Bay Watersheds 2009-2016', specialWeight='finalweight_Panel2'),
    # Sampling Phase
    estimateBioPanelPhase1 = subpopEstimate(finalData,parameterName, 'BioPanel', 'Phase1','VSCI Scores 2001-2004', specialWeight='finalweight_BioPanel1'),
    estimateBioPanelPhase2 = subpopEstimate(finalData,parameterName, 'BioPanel', 'Phase2','VSCI Scores 2005-2008', specialWeight='finalweight_BioPanel2'),
    estimateBioPanelPhase3 = subpopEstimate(finalData,parameterName, 'BioPanel', 'Phase3','VSCI Scores 2009-2012', specialWeight='finalweight_BioPanel3'),
    estimateBioPanelPhase4 = subpopEstimate(finalData,parameterName, 'BioPanel', 'Phase4','VSCI Scores 2013-2016', specialWeight='finalweight_BioPanel4'),
    # IR window
    estimateIR2008 = subpopEstimate(finalData,parameterName, 'IR2008', '2008','IR2008', specialWeight='finalweight_IR2008'),
    estimateIR2010 = subpopEstimate(finalData,parameterName, 'IR2010', '2010','IR2010', specialWeight='finalweight_IR2010'),
    estimateIR2012= subpopEstimate(finalData,parameterName, 'IR2012', '2012','IR2012', specialWeight='finalweight_IR2012'),
    estimateIR2014 = subpopEstimate(finalData,parameterName, 'IR2014', '2014','IR2014', specialWeight='finalweight_IR2014'),
    estimateIR2016 = subpopEstimate(finalData,parameterName, 'IR2016', '2016','IR2016', specialWeight='finalweight_IR2016'),
    estimateIR2018 = subpopEstimate(finalData,parameterName, 'IR2018', '2018','IR2018', specialWeight='finalweight_IR2018'),
    
    # Stream size
    estimateSmall = subpopEstimate(finalData,parameterName, 'StreamSizeCat','Small',NA, specialWeight=FALSE),
    estimateMedium = subpopEstimate(finalData,parameterName, 'StreamSizeCat','Medium',NA, specialWeight=FALSE),
    estimateLarge = subpopEstimate(finalData,parameterName, 'StreamSizeCat','Large',NA, specialWeight=FALSE),
    # Stream size and sample phase
    estimatePhase1Small = subpopEstimate(finalData,parameterName, 'StreamSizeCatPhase','Phase1Small',NA, specialWeight='finalweight_Panel1'),
    estimatePhase2Small = subpopEstimate(finalData,parameterName, 'StreamSizeCatPhase','Phase2Small',NA, specialWeight='finalweight_Panel2'),
    estimatePhase1Medium = subpopEstimate(finalData,parameterName, 'StreamSizeCatPhase','Phase1Medium',NA, specialWeight='finalweight_Panel1'),
    estimatePhase2Medium = subpopEstimate(finalData,parameterName, 'StreamSizeCatPhase','Phase2Medium',NA, specialWeight='finalweight_Panel2'),
    estimatePhase1Large = subpopEstimate(finalData,parameterName, 'StreamSizeCatPhase','Phase1Large',NA, specialWeight='finalweight_Panel1'),
    estimatePhase2Large = subpopEstimate(finalData,parameterName, 'StreamSizeCatPhase','Phase2Large',NA, specialWeight='finalweight_Panel2')
  )
}

allCDFresults <- function(designStatus, surveyData, parameter){
  
  # Organize new parameter data
  parameterData <- data.frame(select(surveyData,siteID,parameter))
  parameterData[,2] <- as.numeric(as.character(parameterData[,2])) # change to numeric in case it was saved as anything else
  
  
  # Change status if it wasnt sampled
  initialWeightData <- left_join(designStatus,parameterData,by='siteID') %>%
    mutate(parameter_status=ifelse(status == "TS" & is.na(!!as.name(parameter)),"OT", # if TS but not sampled, change to OT
                                   ifelse(status == "OT" & is.na(!!as.name(parameter)),"OT", # if OT but not sampled, keep OT
                                          ifelse(status == "PD", "PD", # if PD, keep it
                                                 ifelse(status == 'NT','NT', # if NT, keep it
                                                        ifelse(status == "TS",'TS', NA))))), # if TS AND sampled, keep as TS
           designweightoriginal = as.factor(`strahler order`), # easier to change as factor
           designweightoriginal = dplyr::recode(designweightoriginal,`1`="3790.5165999999999",
                                                `2`="947.62919999999997",
                                                `3`="541.50239999999997",
                                                `4`="315.87639999999999", 
                                                `5`="140.3895", 
                                                `6`="140.3895")) # overwrite all design weights back to original
  
  # Adjust initial weights for trend stations across various data windows
  # First calculate number of times sampled in each window
  
  trendWeightAdjustments <- mutate(initialWeightData,
                                   designweightoriginal = as.numeric(as.character(designweightoriginal)), #factor to numeric
                                   siteIDoriginal=gsub("_.*$", "", siteID)) %>% # get rid of concatenated year for trends to make calculations easier
    # Full window
    group_by(siteIDoriginal) %>% 
    mutate(nYearsSampled = ifelse(is.na(siteIDoriginal),NA,n())) %>%
    ungroup()%>%
    # 2018 IR
    group_by(siteIDoriginal, IR2018) %>%
    mutate(nYearsSampled_IR2018 = ifelse(is.na(IR2018),NA,n())) %>%
    ungroup() %>%
    # 2016 IR
    group_by(siteIDoriginal, IR2016) %>%
    mutate(nYearsSampled_IR2016 = ifelse(is.na(IR2016),NA,n())) %>%
    ungroup()%>%
    # 2014 IR
    group_by(siteIDoriginal, IR2014) %>%
    mutate(nYearsSampled_IR2014 = ifelse(is.na(IR2014),NA,n()))%>%
    ungroup()%>%
    # 2012 IR
    group_by(siteIDoriginal, IR2012) %>%
    mutate(nYearsSampled_IR2012 = ifelse(is.na(IR2012),NA,n())) %>%
    ungroup()%>%
    # 2010 IR
    group_by(siteIDoriginal, IR2010) %>%
    mutate(nYearsSampled_IR2010 = ifelse(is.na(IR2010),NA,n())) %>%
    ungroup()%>%
    # 2008 IR
    group_by(siteIDoriginal, IR2008) %>%
    mutate(nYearsSampled_IR2008 = ifelse(is.na(IR2008),NA,n())) %>%
    # Panels
    group_by(siteIDoriginal, Panel1) %>%
    mutate(nYearsSampled_Panel1 = ifelse(is.na(Panel1),NA,n())) %>%
    ungroup()%>%
    group_by(siteIDoriginal, Panel2) %>%
    mutate(nYearsSampled_Panel2 = ifelse(is.na(Panel2),NA,n())) %>%
    ungroup()%>%
    # Biopanels
    group_by(siteIDoriginal, BioPanel1) %>%
    mutate(nYearsSampled_BioPanel1 = ifelse(is.na(BioPanel1),NA,n())) %>%
    ungroup() %>% 
    group_by(siteIDoriginal, BioPanel2) %>%
    mutate(nYearsSampled_BioPanel2 = ifelse(is.na(BioPanel2),NA,n())) %>%
    ungroup() %>% 
    group_by(siteIDoriginal, BioPanel3) %>%
    mutate(nYearsSampled_BioPanel3 = ifelse(is.na(BioPanel3),NA,n())) %>%
    ungroup() %>% 
    group_by(siteIDoriginal, BioPanel4) %>%
    mutate(nYearsSampled_BioPanel4 = ifelse(is.na(BioPanel4),NA,n())) %>%
    ungroup() %>% 
    # Divide out weight by years sampled in each window
    # if the site wasnt sampled in a window, give it the original weight but it will be adjusted according to an OT status later
    mutate(designweight_all= designweightoriginal/nYearsSampled,
           designweight_IR2018= ifelse(is.na(nYearsSampled_IR2018),designweightoriginal,designweightoriginal/nYearsSampled_IR2018),
           designweight_IR2016= ifelse(is.na(nYearsSampled_IR2016),designweightoriginal,designweightoriginal/nYearsSampled_IR2016),
           designweight_IR2014= ifelse(is.na(nYearsSampled_IR2014),designweightoriginal,designweightoriginal/nYearsSampled_IR2014),
           designweight_IR2012= ifelse(is.na(nYearsSampled_IR2012),designweightoriginal,designweightoriginal/nYearsSampled_IR2012),
           designweight_IR2010= ifelse(is.na(nYearsSampled_IR2010),designweightoriginal,designweightoriginal/nYearsSampled_IR2010),
           designweight_IR2008= ifelse(is.na(nYearsSampled_IR2008),designweightoriginal,designweightoriginal/nYearsSampled_IR2008),
           designweight_Panel1= ifelse(is.na(nYearsSampled_Panel1),designweightoriginal,designweightoriginal/nYearsSampled_Panel1),
           designweight_Panel2= ifelse(is.na(nYearsSampled_Panel2),designweightoriginal,designweightoriginal/nYearsSampled_Panel2),
           designweight_BioPanel1= ifelse(is.na(nYearsSampled_BioPanel1),designweightoriginal,designweightoriginal/nYearsSampled_BioPanel1),
           designweight_BioPanel2= ifelse(is.na(nYearsSampled_BioPanel2),designweightoriginal,designweightoriginal/nYearsSampled_BioPanel2),
           designweight_BioPanel3= ifelse(is.na(nYearsSampled_BioPanel3),designweightoriginal,designweightoriginal/nYearsSampled_BioPanel3),
           designweight_BioPanel4= ifelse(is.na(nYearsSampled_BioPanel4),designweightoriginal,designweightoriginal/nYearsSampled_BioPanel4))
  
  
  ## Adjust design weights to get final weights
  
  # Initial sample frame inputs
  # List stream order by kilometer it represents
  sframe <- c('1st'=51210, '2nd'=13680, '3rd'=7781.08, '4th'=4448.257, 
              '5th'=1731.302, '6th'=163.901, '7th'=14.7099 )
  
  # recode to factor to make sframe match up to stream order
  trendWeightAdjustments$`strahler order` <- as.factor(trendWeightAdjustments$`strahler order`)
  levels(trendWeightAdjustments$`strahler order`) <- c('1st','2nd','3rd','4th','5th','6th','7th')
  
  finalWeights <- select(trendWeightAdjustments,siteID:IR2018,siteIDoriginal,designweightoriginal,designweight_all:designweight_BioPanel4,
                         parameter_status,!!as.name(parameter))
  finalWeights$finalweight_Year <- adjwgt(rep(TRUE,length(finalWeights$designweightoriginal)),finalWeights$designweightoriginal,
                                          finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_all <- adjwgt(rep(TRUE,length(finalWeights$designweight_all)),finalWeights$designweight_all,
                                         finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_IR2018 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2018)),finalWeights$designweight_IR2018,
                                            finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_IR2016 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2016)),finalWeights$designweight_IR2016,
                                            finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_IR2014 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2014)),finalWeights$designweight_IR2014,
                                            finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_IR2012 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2012)),finalWeights$designweight_IR2012,
                                            finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_IR2010 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2010)),finalWeights$designweight_IR2010,
                                            finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_IR2008 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2008)),finalWeights$designweight_IR2008,
                                            finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_Panel1 <- adjwgt(rep(TRUE,length(finalWeights$designweight_Panel1)),finalWeights$designweight_Panel1,
                                            finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_Panel2 <- adjwgt(rep(TRUE,length(finalWeights$designweight_Panel2)),finalWeights$designweight_Panel2,
                                            finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_BioPanel1 <- adjwgt(rep(TRUE,length(finalWeights$designweight_BioPanel1)),finalWeights$designweight_BioPanel1,
                                               finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_BioPanel2 <- adjwgt(rep(TRUE,length(finalWeights$designweight_BioPanel2)),finalWeights$designweight_BioPanel2,
                                               finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_BioPanel3 <- adjwgt(rep(TRUE,length(finalWeights$designweight_BioPanel3)),finalWeights$designweight_BioPanel3,
                                               finalWeights$`strahler order`, sframe)
  finalWeights$finalweight_BioPanel4 <- adjwgt(rep(TRUE,length(finalWeights$designweight_BioPanel4)),finalWeights$designweight_BioPanel4,
                                               finalWeights$`strahler order`, sframe)
  
  
  
  # Change decimal degree coordinates to marinus for equal area projection (needed for spsurvey::cat.analysis())
  marinus <- spsurvey::marinus(finalWeights$`Latitude-DD`,finalWeights$`Longitude-DD`)
  finalWeights <- cbind(finalWeights,data.frame(xmarinus=marinus$x,ymarinus=marinus$y))
  rm(marinus)
  
  ####Stream Extent and Status Estimate
  
  siteExtent <- data.frame(siteID=finalWeights$siteID, Use=rep(TRUE,nrow(finalWeights)) )
  subpopExtent <- data.frame(siteID=finalWeights$siteID,Region=rep('Virginia',nrow(finalWeights)) )
  designExtent <- data.frame(siteID=finalWeights$siteID,stratum=rep(1,nrow(finalWeights)),
                             wgt=finalWeights$finalweight_all, xcoord=finalWeights$xmarinus,ycoord=finalWeights$ymarinus)
  
  StatusTNT <- finalWeights$status
  levels(StatusTNT) <- list(T=c('TS','PD','OT'), NT=c('NT') )
  
  data.cat.ext <- data.frame(finalWeights[,c('siteID','status')],StatusTNT)
  
  popstatus.est <- cat.analysis(sites = siteExtent, subpop = subpopExtent, design = designExtent,
                                data.cat = data.cat.ext, conf=95, vartype="Local")
  
  dataAnalyzed <- filter(finalWeights, parameter_status=='TS') %>%
    select(siteID,!!as.name(parameter),parameter_status,everything())
  
  output <- listOfResults(popstatus.est, dataAnalyzed, parameter)
  
  return(output)
}

```


Below is how one would run a single parameter and unpack the CDF and PCT data into individual data frames. To view the list structure or data, follow script examples.

```{r runIndividualParameter}
LRBS <- allCDFresults(designStatus, surveyData,'LRBS')
LRBS_CDFdf <- suppressWarnings(LRBS[3:77] %>% map_df(1))
LRBS_PCTdf <-  suppressWarnings(LRBS[3:77] %>% map_df(2))


```

Same for VSCI and how to get all CDF estimates at VSCI=60.

```{r VSCIexample}
# VLOOKUP (Excel function hack) by Julin Maloof, edited for list application by Emma Jones
vlookupEVJ <- function(table, #the table where you want to look for it; will look in first column
                       ref, #the value or values that you want to look for
                       column, #the column that you want the return data to come from,
                       range=FALSE, #if there is not an exact match, return the closest?
                       larger=FALSE) #if doing a range lookup, should the smaller or larger key be used?)
{
  if(!is.numeric(column) & !column %in% colnames(table)) {
    stop(paste("can't find column",column,"in table"))
  }
  if(range) {
    if(!is.numeric(table[,1])) {
      stop(paste("The first column of table must be numeric when using range lookup"))
    }
    table <- table[order(table[,1]),] 
    index <- findInterval(ref,table[,1])
    if(larger) {
      index <- ifelse(ref %in% table[,1],index,index+1)
    }
    output <- table[index,column]
    output[!index <= dim(table)[1]] <- NA
    
  } else {
    output <- table[match(ref,table[,1]),column]
    output[!ref %in% table[,1]] <- NA #not needed?
  }
  dim(output) <- dim(ref)
  output
}


# run VSCI
VSCI <- allCDFresults(designStatus, surveyData,'VSCIVCPMI')



# find CDF results at 60 for all subpopulations
VSCI60 <- listsOnListsOnLists %>% # start with our big 'ol list of lists
  map('CDF') %>% #extract just the 'CDF' list from each list item (subpopulation)
  map(`[`, c('Value','Estimate.P')) %>% # kinda like dplyr::select here, extract the Value and Estimate.P columns from each list item (CDF)
  map( vlookupEVJ, 60  , 2, TRUE) %>% # use the vlookup function on each of the tables to find the Estimate.P where value = 60
  tibble::enframe(value = "CDFestimateAt60") # change the results from that list into a tibble (kinda like dataframe)

View(VSCI60)
```


### Run all parameters

```{r runEverything}
# probably a cooler way to do this with purrr, but here is my one for loop
for(i in 3:length(surveyData)){
  assign(names(surveyData)[i], suppressWarnings(allCDFresults(designStatus, surveyData,names(surveyData)[i])))
}

# Then unpack each parameter to get a long df of CDF and PCT data
# Needs to be in separate loop so names of each object to be called will be in the environment
allCDF <- data.frame(Type=NA,Subpopulation=NA,Indicator=NA,Value=NA,NResp=NA,Estimate.P=NA,StdError.P=NA,LCB95Pct.P=NA,UCB95Pct.P=NA,   
                     Estimate.U=NA,StdError.U=NA,LCB95Pct.U=NA,UCB95Pct.U=NA)
allPCT <- data.frame(Type=NA,Subpopulation=NA,Indicator=NA,Statistic=NA,NResp=NA,Estimate=NA,StdError=NA,LCB95Pct=NA,UCB95Pct=NA)

# okay, one last one, I promise
for(i in 3:length(surveyData)){
  assign(paste(names(surveyData)[i],"CDFdf",sep="_"),suppressWarnings(get(names(surveyData)[i])[3:77] %>% map_df(1)))
  assign(paste(names(surveyData)[i],"PCTdf",sep="_"),suppressWarnings(get(names(surveyData)[i])[3:77] %>% map_df(2)))
  allCDF <- rbind(allCDF,get(paste(names(surveyData)[i],"CDFdf",sep="_")))
  allPCT <- rbind(allPCT,get(paste(names(surveyData)[i],"PCTdf",sep="_")))
  
}

write.csv(allCDF,'processedData/allCDF.csv',row.names = F)
write.csv(allPCT,'processedData/allPCT.csv',row.names = F)


```
































# old way




#### Weight Adjustments
Previous to this step, Jason had taken the original sample weights and divided by number of years sampled. The "design weight" column represents the weights **AFTER** dividing out trend years. THis is not the most accurate way of calculating design weights for trend sites, however. Weights need to be adjusted by each parameter run through analysis. Weights also need to be adjusted by various temporal windows (e.g. IR windows, Phases, Biophases). 

Step 1: Set design weight back to original weights based on Strahler order/weight category. These will change when we get a non-wadeable biological index, but for now they are as follows.

```{r backToOriginalWeights}
trendWeightAdjustments <- mutate(designStatus,designweightoriginal = as.factor(`strahler order`), # easier to change as factor
                                 designweightoriginal = dplyr::recode(designweightoriginal,`1`="3790.5165999999999",
                                                                      `2`="947.62919999999997",
                                                                      `3`="541.50239999999997",
                                                                      `4`="315.87639999999999", 
                                                                      `5`="140.3895", 
                                                                      `6`="140.3895")) # overwrite all design weights back to original

```


Step 2: Now count number of years a given site was sampled within a time window. We are using:

* Full sample window (2001-2016)
* 2018 IR (2011-2016)
* 2016 IR (2009-2014)
* 2014 IR (2007-2012)
* 2012 IR (2005-2010)
* 2010 IR (2003-2008)
* 2008 IR (2001-2007)
* Phases (Phase 1= 2001-2008; Phase 2= 2009-2016)
* BioPhases (BioPhase 1 = 2001-2004; BioPhase 1 = 2005-2008; BioPhase 1 = 2009-2012; BioPhase 1 = 2013-2016;)

Scroll right in table to see sample year breakdown.

```{r nYearsSampled}
trendWeightAdjustments <- mutate(trendWeightAdjustments,
                                 designweightoriginal = as.numeric(as.character(designweightoriginal)), #factor to numeric
                                 siteIDoriginal=gsub("_.*$", "", siteID)) %>% # get rid of concatenated year for trends to make calculations easier
  # Full window
  group_by(siteIDoriginal) %>% 
  mutate(nYearsSampled = ifelse(is.na(siteIDoriginal),NA,n())) %>%
  ungroup()%>%
  # 2018 IR
  group_by(siteIDoriginal, IR2018) %>%
  mutate(nYearsSampled_IR2018 = ifelse(is.na(IR2018),NA,n())) %>%
  ungroup() %>%
  # 2016 IR
  group_by(siteIDoriginal, IR2016) %>%
  mutate(nYearsSampled_IR2016 = ifelse(is.na(IR2016),NA,n())) %>%
  ungroup()%>%
  # 2014 IR
  group_by(siteIDoriginal, IR2014) %>%
  mutate(nYearsSampled_IR2014 = ifelse(is.na(IR2014),NA,n()))%>%
  ungroup()%>%
  # 2012 IR
  group_by(siteIDoriginal, IR2012) %>%
  mutate(nYearsSampled_IR2012 = ifelse(is.na(IR2012),NA,n())) %>%
  ungroup()%>%
  # 2010 IR
  group_by(siteIDoriginal, IR2010) %>%
  mutate(nYearsSampled_IR2010 = ifelse(is.na(IR2010),NA,n())) %>%
  ungroup()%>%
  # 2008 IR
  group_by(siteIDoriginal, IR2008) %>%
  mutate(nYearsSampled_IR2008 = ifelse(is.na(IR2008),NA,n())) %>%
  # Panels
  group_by(siteIDoriginal, Panel1) %>%
  mutate(nYearsSampled_Panel1 = ifelse(is.na(Panel1),NA,n())) %>%
  ungroup()%>%
  group_by(siteIDoriginal, Panel2) %>%
  mutate(nYearsSampled_Panel2 = ifelse(is.na(Panel2),NA,n())) %>%
  ungroup()%>%
  # Biopanels
  group_by(siteIDoriginal, BioPanel1) %>%
  mutate(nYearsSampled_BioPanel1 = ifelse(is.na(BioPanel1),NA,n())) %>%
  ungroup() %>% 
  group_by(siteIDoriginal, BioPanel2) %>%
  mutate(nYearsSampled_BioPanel2 = ifelse(is.na(BioPanel2),NA,n())) %>%
  ungroup() %>% 
  group_by(siteIDoriginal, BioPanel3) %>%
  mutate(nYearsSampled_BioPanel3 = ifelse(is.na(BioPanel3),NA,n())) %>%
  ungroup() %>% 
  group_by(siteIDoriginal, BioPanel4) %>%
  mutate(nYearsSampled_BioPanel4 = ifelse(is.na(BioPanel4),NA,n())) %>%
  ungroup() %>% 
  # Divide out weight by years sampled in each window
  # if the site wasnt sampled in a window, give it the original weight but it will be adjusted according to an OT status later
  mutate(designweight_all= designweightoriginal/nYearsSampled,
         designweight_IR2018= ifelse(is.na(nYearsSampled_IR2018),designweightoriginal,designweightoriginal/nYearsSampled_IR2018),
         designweight_IR2016= ifelse(is.na(nYearsSampled_IR2016),designweightoriginal,designweightoriginal/nYearsSampled_IR2016),
         designweight_IR2014= ifelse(is.na(nYearsSampled_IR2014),designweightoriginal,designweightoriginal/nYearsSampled_IR2014),
         designweight_IR2012= ifelse(is.na(nYearsSampled_IR2012),designweightoriginal,designweightoriginal/nYearsSampled_IR2012),
         designweight_IR2010= ifelse(is.na(nYearsSampled_IR2010),designweightoriginal,designweightoriginal/nYearsSampled_IR2010),
         designweight_IR2008= ifelse(is.na(nYearsSampled_IR2008),designweightoriginal,designweightoriginal/nYearsSampled_IR2008),
         designweight_Panel1= ifelse(is.na(nYearsSampled_Panel1),designweightoriginal,designweightoriginal/nYearsSampled_Panel1),
         designweight_Panel2= ifelse(is.na(nYearsSampled_Panel2),designweightoriginal,designweightoriginal/nYearsSampled_Panel2),
         designweight_BioPanel1= ifelse(is.na(nYearsSampled_BioPanel1),designweightoriginal,designweightoriginal/nYearsSampled_BioPanel1),
         designweight_BioPanel2= ifelse(is.na(nYearsSampled_BioPanel2),designweightoriginal,designweightoriginal/nYearsSampled_BioPanel2),
         designweight_BioPanel3= ifelse(is.na(nYearsSampled_BioPanel3),designweightoriginal,designweightoriginal/nYearsSampled_BioPanel3),
         designweight_BioPanel4= ifelse(is.na(nYearsSampled_BioPanel4),designweightoriginal,designweightoriginal/nYearsSampled_BioPanel4))
                                      
  
datatable(trendWeightAdjustments, options=list(dom = 't', scrollY = "400px",scrollX = TRUE))

```


Step 3: Now it is time to adjust the weights based on each sample window design weight. 

```{r weightAdjustments, eval=F}
# Initial sample frame inputs
# List stream order by kilometer it represents
sframe <- c('1st'=51210, '2nd'=13680, '3rd'=7781.08, '4th'=4448.257, 
            '5th'=1731.302, '6th'=163.901, '7th'=14.7099 )


finalWeights_all <- select(trendWeightAdjustments,siteID, Year,status, `Longitude-DD`, `Latitude-DD`, 
                       designweight_all,`weight category`,`strahler order`)

finalWeights_all$`strahler order` <- as.factor(finalWeights_all$`strahler order`)
levels(finalWeights_all$`strahler order`) <- c('1st','2nd','3rd','4th','5th','6th','7th')
#table(finalWeights_all$`strahler order`,dsgnstatus$MDCaty)
wgt <- sframe/table(finalWeights_all$`strahler order`)

finalWeights_all$finalweight<- adjwgt(rep(TRUE,nrow(finalWeights_all)), finalWeights_all$designweight_all,
                                  finalWeights_all$`strahler order`, sframe)
rm(wgt)
```


```{r weightAdjustmentByWindow}
# Initial sample frame inputs
# List stream order by kilometer it represents
sframe <- c('1st'=51210, '2nd'=13680, '3rd'=7781.08, '4th'=4448.257, 
            '5th'=1731.302, '6th'=163.901, '7th'=14.7099 )

# recode to factor to make sframe match up to stream order
trendWeightAdjustments$`strahler order` <- as.factor(trendWeightAdjustments$`strahler order`)
levels(trendWeightAdjustments$`strahler order`) <- c('1st','2nd','3rd','4th','5th','6th','7th')

finalWeights <- select(trendWeightAdjustments,siteID:IR2018,siteIDoriginal,designweightoriginal,designweight_all:designweight_BioPanel4)
finalWeights$finalweight_Year <- adjwgt(rep(TRUE,length(finalWeights$designweightoriginal)),finalWeights$designweightoriginal,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_all <- adjwgt(rep(TRUE,length(finalWeights$designweight_all)),finalWeights$designweight_all,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_IR2018 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2018)),finalWeights$designweight_IR2018,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_IR2016 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2016)),finalWeights$designweight_IR2016,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_IR2014 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2014)),finalWeights$designweight_IR2014,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_IR2012 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2012)),finalWeights$designweight_IR2012,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_IR2010 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2010)),finalWeights$designweight_IR2010,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_IR2008 <- adjwgt(rep(TRUE,length(finalWeights$designweight_IR2008)),finalWeights$designweight_IR2008,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_Panel1 <- adjwgt(rep(TRUE,length(finalWeights$designweight_Panel1)),finalWeights$designweight_Panel1,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_Panel2 <- adjwgt(rep(TRUE,length(finalWeights$designweight_Panel2)),finalWeights$designweight_Panel2,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_BioPanel1 <- adjwgt(rep(TRUE,length(finalWeights$designweight_BioPanel1)),finalWeights$designweight_BioPanel1,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_BioPanel2 <- adjwgt(rep(TRUE,length(finalWeights$designweight_BioPanel2)),finalWeights$designweight_BioPanel2,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_BioPanel3 <- adjwgt(rep(TRUE,length(finalWeights$designweight_BioPanel3)),finalWeights$designweight_BioPanel3,
                                                finalWeights$`strahler order`, sframe)
finalWeights$finalweight_BioPanel4 <- adjwgt(rep(TRUE,length(finalWeights$designweight_BioPanel4)),finalWeights$designweight_BioPanel4,
                                                finalWeights$`strahler order`, sframe)

# Function to do the above calculations based on window and change status based on window
#weightAdjustment <- function(finalWeights,designweight_window){
#  dat <- select(finalWeights, siteID, Year, status, designweight_window, `strahler order`) %>%
#    dplyr::rename(window=!!names(.[4])) %>%
#    mutate(status_window=ifelse(status == "TS" & is.na(window),"OT",
#                                ifelse(status == "TS" & !is.na(window),'TS',  
#                                       ifelse(status == "PD", "PD",
#                                              ifelse(status == 'NT','NT',
#                                                     ifelse(status == "OT","OT",NA))))))
#  adjwgt(rep(TRUE,nrow(dat)),dat$window,dat$`strahler order`, sframe)
#}
                       

#finalWeights$finalweight_IR20182 <- weightAdjustment(finalWeights,"designweight_IR2018")
```

Change decimal degree coordinates to marinus for equal area projection (needed for spsurvey::cat.analysis())
```{r toMarinus}
marinus <- spsurvey::marinus(finalWeights$`Latitude-DD`,finalWeights$`Longitude-DD`)
finalWeights <- cbind(finalWeights,data.frame(xmarinus=marinus$x,ymarinus=marinus$y))
rm(marinus)
```

####Stream Extent and Status Estimate

```{r populationStatusEstimate}
siteExtent <- data.frame(siteID=finalWeights$siteID, Use=rep(TRUE,nrow(finalWeights)) )
subpopExtent <- data.frame(siteID=finalWeights$siteID,Region=rep('Virginia',nrow(finalWeights)) )
designExtent <- data.frame(siteID=finalWeights$siteID,stratum=rep(1,nrow(finalWeights)),
                           wgt=finalWeights$finalweight_all, xcoord=finalWeights$xmarinus,ycoord=finalWeights$ymarinus)

StatusTNT <- finalWeights$status
levels(StatusTNT) <- list(T=c('TS','PD','OT'), NT=c('NT') )

data.cat.ext <- data.frame(finalWeights[,c('siteID','status')],StatusTNT)

popstatus.est <- cat.analysis(sites = siteExtent, subpop = subpopExtent, design = designExtent,
                              data.cat = data.cat.ext, conf=95, vartype="Local")
rm(siteExtent);rm(subpopExtent);rm(designExtent);rm(data.cat.ext);rm(StatusTNT)
```

#### CDF data

Now this is where we run each parameter through analyses to generate CDF and percent estimates for each parameter.

```{r CDFrun}
# Match finalWeights information with surveyData
finalData <- left_join(surveyData,finalWeights,by='siteID') #%>%
  #left_join(select(designStatus,siteID,Basin,SubBasin,BayShed,BayPanel,EcoRegion,BioRegion,Panel,BioPanel,Order,BasinSize,
  #                 StreamSizeCat,StreamSizeCatPhase,IR2008,IR2010,IR2012,IR2014,IR2016,IR2018),
  #          by='siteID')
# does site status agree with having data available?
table(finalData$status)

VSCI <- listOfSubpopulations(finalData, 'VSCIVCPMI')
VSCI_CDFdf <- suppressWarnings(VSCI %>% map_df(1))
VSCI_PCTdf <-  suppressWarnings(VSCI %>% map_df(2))

```




Now how to go through these one parameter at a time.

```{r multipleCDFruns}

allCDFresults <- function(designStatus, surveyData){
  ## Start with VSCI then move through list
  
}


```






