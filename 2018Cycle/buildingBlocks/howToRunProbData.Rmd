---
title: "How to Write Probabilistic Monitoring Integrated Report Chapter"
output:
  html_document:
    df_print: paged
---

This document walks you through the steps of calculating design weights, running analyses, and writing the Integrated Report chapter for the Probabilistic Monitoring Program due to EPA every two years. This document overviews the 2018 IR ProbMon chapter and the Change Analysis chapter due every ~6 years.

### Data Organization
Starting with an organized 'design status' database that has all Probmon stations (sampled or not) organized with stream order information. This data is important to note all sites that were evaluated and whether or not they should be included in the design weight process. Environmental, chemical, landcover, etc. data is organized in a separate spreadsheet (brought in later) that is joined to the weight category results. 

```{r startup, echo=FALSE, warning=FALSE}
# R version 3.4.4 "Someone to Lean On"
suppressPackageStartupMessages(library(tidyverse))#1.2.1
suppressPackageStartupMessages(library(sf))#0.6-1
suppressPackageStartupMessages(library(spsurvey))#3.3

```

Bring in appropriate datasets. Always start with VSCI (VSCP/VCPMI) first because this parameter will have the best information on whether or not to include the station for design weight calculations. 
```{r bringInData}
designStatus <- readxl::read_excel('originalData/biology.xlsx',sheet='biology2018') %>%
  mutate(BioPanel= dplyr::recode(BioPanel,'Phase1'='BioPhase1','Phase2'='BioPhase2',
                                 'Phase3'='BioPhase3','Phase4'='BioPhase4')) %>% # recode biophase
  dplyr::rename(siteID=sampleID)

#### Read in master field data sampled at all sites
surveyData <- readxl::read_excel('originalData/ProbMonWadeable2001-2016.xlsx',sheet='ProbMonData2001-2016_EVJ') %>%
  select(StationID_Trend,VSCIVCPMI) %>% # start with VSCI
  dplyr::rename(siteID=StationID_Trend)

```



#### Weight Adjustments
Previous to this step, Jason had taken the original sample weights and divided by number of years sampled. The "design weight" column represents the weights **AFTER** dividing out trend years. Weights need to be adjusted by each parameter run through analysis. Weights also need to be adjusted by various temporal windows (e.g. IR windows, Phases, Biophases). 

```{r weightAdjustment}
# Initial sample frame inputs
# List stream order by kilometer it represents
sframe <- c('1st'=51210, '2nd'=13680, '3rd'=7781.08, '4th'=4448.257, 
            '5th'=1731.302, '6th'=163.901, '7th'=14.7099 )


finalWeights <- select(designStatus,siteID, Year,status, `Longitude-DD`, `Latitude-DD`, 
                       `design weight`,`weight category`,`strahler order`)

finalWeights$`strahler order` <- as.factor(finalWeights$`strahler order`)
levels(finalWeights$`strahler order`) <- c('1st','2nd','3rd','4th','5th','6th','7th')
#table(finalWeights$`strahler order`,dsgnstatus$MDCaty)
wgt <- sframe/table(finalWeights$`strahler order`)

finalWeights$finalweight<- adjwgt(rep(TRUE,nrow(finalWeights)), finalWeights$`design weight`,
                                  finalWeights$`strahler order`, sframe)

```

Change decimal degree coordinates to marinus for equal area projection (needed for spsurvey::cat.analysis())
```{r toMarinus}
marinus <- spsurvey::marinus(finalWeights$`Latitude-DD`,finalWeights$`Longitude-DD`)
finalWeights <- cbind(finalWeights,data.frame(xmarinus=marinus$x,ymarinus=marinus$y))
rm(marinus)
```

####Stream Extent and Status Estimate
```{r populationStatusEstimate}
siteExtent <- data.frame(siteID=finalWeights$siteID, Use=rep(TRUE,nrow(finalWeights)) )
subpopExtent <- data.frame(siteID=finalWeights$siteID,Region=rep('Virginia',nrow(finalWeights)) )
designExtent <- data.frame(siteID=finalWeights$siteID,stratum=rep(1,nrow(finalWeights)),
                           wgt=finalWeights$finalweight, xcoord=finalWeights$xmarinus,ycoord=finalWeights$ymarinus)

StatusTNT <- finalWeights$status
levels(StatusTNT) <- list(T=c('TS','PD','OT'), NT=c('NT') )

data.cat.ext <- data.frame(finalWeights[,c('siteID','status')],StatusTNT)

popstatus.est <- cat.analysis(sites = siteExtent, subpop = subpopExtent, design = designExtent,
                              data.cat = data.cat.ext, conf=95, vartype="Local")
rm(siteExtent);rm(subpopExtent);rm(designExtent)
```

#### CDF data

```{r CDFrun}
# Match finalWeights information with surveyData
finalData <- left_join(surveyData,finalWeights,by='siteID') %>%
  left_join(select(designStatus,siteID,Basin,SubBasin,BayShed,BayPanel,EcoRegion,BioRegion,Panel,BioPanel,Order,BasinSize,
                   StreamSizeCat,StreamSizeCatPhase,IR2008,IR2010,IR2012,IR2014,IR2016,IR2018),
            by='siteID')
# does site status agree with having data available?
table(finalData$status)

VSCI <- listOfSubpopulations(finalData, 'VSCIVCPMI')
VSCI_CDFdf <- suppressWarnings(VSCI %>% map_df(1))
VSCI_PCTdf <-  suppressWarnings(VSCI %>% map_df(2))

```













Calculate number of times trend sites sample for adjustments of weights based on IR window, Biopanel, and Phase.
```{r}
trendWeightAdjustments <- mutate(designStatus,designweight = as.factor(`strahler order`)) %>% # overwrite all design weights back to original
  mutate(designweight = dplyr::recode(designweight,`1`="3790.5165999999999",`2`="947.62919999999997", 
                                      `3`="541.50239999999997",`4`="315.87639999999999", 
                                      `5`="140.3895", `6`="140.3895"),
         IR2008 = replace(IR2008, IR2008==1, NA),
         IR2010 = replace(IR2010, IR2010==1, NA),
         IR2012 = replace(IR2012, IR2012==1, NA),
         IR2014 = replace(IR2014, IR2014==1, NA),
         IR2016 = replace(IR2016, IR2016==1, NA),
         IR2018 = replace(IR2018, IR2018==1, NA)) %>%
  mutate(designweight = as.numeric(as.character(designweight))) %>%
  mutate(siteID=gsub("_.*$", "", siteID))%>%
  group_by(siteID) %>%
  mutate(nYearsSampled = ifelse(is.na(siteID),NA,n())) %>%
  ungroup()%>%
  group_by(siteID, IR2018) %>%
  mutate(nYearsSampled_IR2018 = ifelse(is.na(IR2018),NA,n())) %>%
  group_by(siteID, IR2016) %>%
  mutate(nYearsSampled_IR2016 = ifelse(is.na(IR2016),NA,n())) %>%
  ungroup()%>%
  group_by(siteID, IR2014) %>%
  mutate(nYearsSampled_IR2014 = ifelse(is.na(IR2014),NA,n()))%>%
  ungroup()%>%
  group_by(siteID, IR2012) %>%
  mutate(nYearsSampled_IR2012 = ifelse(is.na(IR2012),NA,n())) %>%
  ungroup()%>%
  group_by(siteID, IR2010) %>%
  mutate(nYearsSampled_IR2010 = ifelse(is.na(IR2010),NA,n())) %>%
  ungroup()%>%
  group_by(siteID, IR2008) %>%
  mutate(nYearsSampled_IR2008 = ifelse(is.na(IR2008),NA,n())) %>%
  #Panels
  group_by(siteID, Panel) %>%
  mutate(nYearsSampled_Panel = ifelse(is.na(Panel),NA,n())) %>%
  ungroup()%>%
  # Biopanels
  group_by(siteID, BioPanel) %>%
  mutate(nYearsSampled_BioPanel = ifelse(is.na(BioPanel),NA,n())) %>%
  ungroup() %>% mutate(designweight_all= designweight/nYearsSampled,
                                      designweight_IR2018= designweight/nYearsSampled_IR2018,
                                      designweight_IR2016= designweight/nYearsSampled_IR2016,
                                      designweight_IR2014= designweight/nYearsSampled_IR2014,
                                      designweight_IR2012= designweight/nYearsSampled_IR2012,
                                      designweight_IR2010= designweight/nYearsSampled_IR2010,
                                      designweight_IR2008= designweight/nYearsSampled_IR2008,
                                      designweight_Panel= designweight/nYearsSampled_Panel,
                                      designweight_BioPanel= designweight/nYearsSampled_BioPanel)
```

